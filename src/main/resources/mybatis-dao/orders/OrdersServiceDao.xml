<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.meandbooksteam2.shoppingmall.dao.orders.OrdersDao">

    <!--JOIN 할 때 필요한 값들을 정희함-->
    <resultMap id="Book" type="com.meandbooksteam2.shoppingmall.dto.BookDto">
        <result column="book_img" property="book_img"></result>
        <result column="book_nm" property="book_nm"></result>
    </resultMap>
    <resultMap id="Member" type="MemberDto">
        <result column="mem_no" property="mem_no"></result>
    </resultMap>


    <select id="getOneOrder" resultType="map" parameterType="hashmap">
        SELECT O.ORDERS_NO
             , O.ORDERS_DATE
             , B.BOOK_NM
             , B.BOOK_IMG
             , O.ORDERS_NM
             , O.ORDERS_PHONENO
             , O.ORDERS_ADDR1
             , O.ORDERS_ADDR2
             , O.ORDERS_ADDR3
             , O.ORDERS_DATE
             , O.ORDERS_QTY
          FROM ORDERS "O" JOIN BOOK "B"
         WHERE ORDERS_NO = #{orders_no}
    </select>

    <!--hashmap으로 받아온 값들을 db에 삽입하는 쿼리-->
    <insert id="insertOrder" parameterType="hashmap">
        INSERT INTO ORDERS(ORDERS_NO, MEM_NO, BOOK_NO, ORDERS_NM,
                           ORDERS_PHONENO, ORDERS_ADDR1, ORDERS_ADDR2, ORDERS_ADDR3,
                           ORDERS_DATE, ORDERS_QTY)
                    VALUES(#{orders_no}, #{mem_no}, #{book_no}, #{orders_nm},
                           #{orders_phoneno}, #{orders_addr1}, #{orders_addr2}, #{orders_addr3},
                           sysdate(), #{orders_qty})
    </insert>

    <!--오늘 주문 건수를 가져오는 쿼리-->
    <select id="getTodayOrder" resultType="_int">
        SELECT COUNT(*) FROM ORDERS WHERE ORDERS_DATE >= CURDATE()
    </select>

    <!--회원 번호를 매개변수로 자신의 모든 주문내역을 가져오는 쿼리-->
    <select id="getMyOrderList" resultType="OrdersDto" parameterType="hashmap">
        SELECT O.ORDERS_NO
             , O.ORDERS_DATE
             , B.BOOK_NM
             , B.BOOK_IMG
             , O.ORDERS_NM
             , O.ORDERS_PHONENO
             , O.ORDERS_ADDR1
             , O.ORDERS_ADDR2
             , O.ORDERS_ADDR3
             , O.ORDERS_DATE
             , O.ORDERS_QTY
          FROM ORDERS "O" JOIN BOOK "B"
            ON O.BOOK_NO = B.BOOK_NO
          JOIN MEMBER "M"
            ON O.MEM_NO = M.MEM_NO
    </select>

    <!--주문페이지에서 default 값을 주기위해 MEMBER 테이블에서 일부 값들을 가져오는 메서드-->
    <select id="getMyInfo" parameterType="hashmap" resultType="MemberDto">
        SELECT MEM_ADDR1
             , MEM_ADDR2
             , MEM_ADDR3
             , MEM_PHONENO
             , MEM_NM
          FROM MEMBER
         WHERE MEM_NO = #{mem_no}
    </select>
</mapper>
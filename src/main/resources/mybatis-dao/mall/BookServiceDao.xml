<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.meandbooksteam2.shoppingmall.dao.mall.BookServiceDao">
    <resultMap id="Orders" type="OrdersDto">
        <result column="orders_qty" property="orders_qty"/>
    </resultMap>
    <select id="listAllBest" resultType="BookDto">
        SELECT RANK() OVER(PARTITION BY B.BOOK_NO ORDER BY O.ORDERS_QTY DESC)
             , B.BOOK_NM
             , B.BOOK_IMG
             , B.BOOK_AUTHOR
             , B.BOOK_PUB
             , B.BOOK_PRICE
             , B.BOOK_NO
          FROM orders "O"
              JOIN book b on b.BOOK_NO = O.BOOK_NO
    </select>
    <select id="listCateBest" resultType="BookDto" parameterType="hashmap">
        SELECT RANK() OVER(PARTITION BY B.BOOK_NO ORDER BY O.ORDERS_QTY DESC)
             , B.BOOK_NM
             , B.BOOK_IMG
             , B.BOOK_AUTHOR
             , B.BOOK_PUB
             , B.BOOK_PRICE
             , B.BOOK_NO
        FROM orders O
                 JOIN book b on b.BOOK_NO = O.BOOK_NO
        WHERE b.BOOK_NO LIKE concat(#{keyword}, '%')
    </select>
    <select id="viewMallBook" resultType="BookDto" parameterType="hashmap">
        select BOOK_NO
             , BOOK_NM
             , BOOK_DESC
             , BOOK_PRICE
             , BOOK_STOCK
             , BOOK_IMG
             , BOOK_PUB
             , BOOK_AUTHOR
             , BOOK_PUB_DATE
             , BOOK_ISBN
             , BOOK_PAGE
          from book
    </select>
    <select id="listMallBook" resultType="BookDto" parameterType="hashmap">
        SELECT B.BOOK_NM
             , B.BOOK_IMG
             , B.BOOK_AUTHOR
             , B.BOOK_PUB
             , B.BOOK_PRICE
             , B.BOOK_NO
        FROM book b
        WHERE b.BOOK_NM LIKE concat('%', #{keyword}, '%')
          OR B.BOOK_AUTHOR LIKE concat('%', #{keyword}, '%')
    </select>
    <insert id="insertCart" parameterType="hashmap">
        insert into cart(cart_no, mem_no, book_no, cart_qty)
        values(#{cart_no}, #{mem_no}, #{book_no}, #{cart_qty})
    </insert>
    <select id="getTodayCart" resultType="_int" parameterType="string">
        select count(*) from cart where CART_NO like concat(#{formattingDate}, '%')
    </select>
</mapper>